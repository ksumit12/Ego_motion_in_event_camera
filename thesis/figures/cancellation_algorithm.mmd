%%{init: {'theme':'base', 'themeVariables': {'primaryColor':'#E3F2FD','primaryTextColor':'#000','primaryBorderColor':'#1976D2','lineColor':'#424242','secondaryColor':'#FFF3E0','tertiaryColor':'#F3E5F5','noteBkgColor':'#FFFDE7','noteTextColor':'#000'}}}%%

flowchart TD
    Start([Real Event e<sub>i</sub><br/>at time t<sub>i</sub>])
    Predict[Predict Location<br/>x'<sub>i</sub> = R(x<sub>i</sub>, ω, Δt)<br/>t'<sub>i</sub> = t<sub>i</sub> + Δt]
    
    BuildTree[Build Spatial Index<br/>KD-Tree on Predicted Events]
    
    SpatialQuery{Find Candidates<br/>within ε<sub>xy</sub>?}
    
    TemporalGate{Temporal Gate<br/>|t<sub>j</sub> - t'<sub>i</sub>| ≤ ε<sub>t</sub>?}
    
    PolarityCheck{Polarity Match?<br/>p<sub>j</sub> ≠ p<sub>i</sub>}
    
    FindClosest[Find Closest<br/>Candidate by Distance]
    
    MNNCheck{Mutual Nearest<br/>Neighbor?}
    
    Cancel[✓ CANCEL<br/>Mark as Matched<br/>Remove Pair]
    
    Keep[✗ KEEP<br/>Residual Event<br/>No Match Found]
    
    Output([Output:<br/>Cancelled Events<br/>+ Residuals])
    
    Start --> Predict
    Predict --> BuildTree
    BuildTree --> SpatialQuery
    
    SpatialQuery -->|No| Keep
    SpatialQuery -->|Yes| TemporalGate
    
    TemporalGate -->|No| Keep
    TemporalGate -->|Yes| PolarityCheck
    
    PolarityCheck -->|No| Keep
    PolarityCheck -->|Yes| FindClosest
    
    FindClosest --> MNNCheck
    
    MNNCheck -->|No| Keep
    MNNCheck -->|Yes| Cancel
    
    Cancel --> Output
    Keep --> Output
    
    %% Styling
    style Start fill:#E3F2FD,stroke:#1976D2,stroke-width:3px,color:#000
    style Predict fill:#FFF3E0,stroke:#F57C00,stroke-width:2px,color:#000
    style BuildTree fill:#FFF3E0,stroke:#F57C00,stroke-width:2px,color:#000
    style SpatialQuery fill:#FFF9C4,stroke:#F9A825,stroke-width:2px,color:#000
    style TemporalGate fill:#FFF9C4,stroke:#F9A825,stroke-width:2px,color:#000
    style PolarityCheck fill:#FFF9C4,stroke:#F9A825,stroke-width:2px,color:#000
    style FindClosest fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px,color:#000
    style MNNCheck fill:#FFF9C4,stroke:#F9A825,stroke-width:2px,color:#000
    style Cancel fill:#C8E6C9,stroke:#388E3C,stroke-width:3px,color:#000
    style Keep fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px,color:#000
    style Output fill:#E3F2FD,stroke:#1976D2,stroke-width:3px,color:#000
    
    %% Link styles
    linkStyle 3 stroke:#D32F2F,stroke-width:2px
    linkStyle 5 stroke:#D32F2F,stroke-width:2px
    linkStyle 7 stroke:#D32F2F,stroke-width:2px
    linkStyle 9 stroke:#D32F2F,stroke-width:2px


